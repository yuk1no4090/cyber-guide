// çº¯å…³é”®è¯å±æœºæ£€æµ‹ï¼ˆå…¼å®¹ DeepSeek ç­‰å›½å†…å¹³å°ï¼‰

// ä¸­æ–‡å±æœºå…³é”®è¯
const CRISIS_KEYWORDS_ZH = [
  'æƒ³æ­»', 'ä¸æƒ³æ´»', 'è‡ªæ€', 'è‡ªæ®‹', 'å‰²è…•', 'è·³æ¥¼', 'è·³æ²³',
  'ç»“æŸç”Ÿå‘½', 'ç¦»å¼€è¿™ä¸ªä¸–ç•Œ', 'æ´»ç€æ²¡æ„æ€', 'ä¸å¦‚æ­»äº†',
  'æ€äº†', 'æƒ³æ€', 'å¼„æ­»', 'æ‰“æ­»', 'ä¼¤å®³ä»–',
  'ä¸æƒ³æ´»äº†', 'å¯»æ­»', 'è½»ç”Ÿ', 'äº†ç»“',
];

// è¯¯è§¦å‘è±å…è¯â€”â€”æ—¥å¸¸å£è¯­ä¸­çš„"æ­»"ä¸æ˜¯å±æœºä¿¡å·
const FALSE_POSITIVE_PATTERNS = [
  'çƒ­æ­»', 'ç´¯æ­»', 'ç¬‘æ­»', 'å†·æ­»', 'é¥¿æ­»', 'å›°æ­»', 'æ€¥æ­»',
  'æ°”æ­»', 'çƒ¦æ­»', 'ä¸‘æ­»', 'å“æ­»', 'æ¸´æ­»', 'å¿™æ­»', 'æ— èŠæ­»',
  'å°´å°¬æ­»', 'ç¾¡æ…•æ­»', 'å¼€å¿ƒæ­»', 'éš¾åƒæ­»', 'å¥½çœ‹æ­»',
];

// å±æœºå›žå¤æ¨¡æ¿
export const CRISIS_RESPONSE = `æˆ‘å¬åˆ°äº†ä½ è¯´çš„è¯ï¼Œè¿™è®©æˆ‘éžå¸¸æ‹…å¿ƒä½ çš„å®‰å…¨ã€‚

ä½ çŽ°åœ¨çš„æ„Ÿå—ä¸€å®šå¾ˆç—›è‹¦ï¼Œæˆ‘æƒ³è®©ä½ çŸ¥é“ï¼Œä½ å¹¶ä¸å­¤å•ã€‚

è¯·çŽ°åœ¨å°±è”ç³»ä¸“ä¸šçš„å¸®åŠ©ï¼š
ðŸ“ž **å…¨å›½å¿ƒç†æ´åŠ©çƒ­çº¿**: 400-161-9995
ðŸ“ž **åŒ—äº¬å¿ƒç†å±æœºç ”ç©¶ä¸Žå¹²é¢„ä¸­å¿ƒ**: 010-82951332
ðŸ“ž **ç”Ÿå‘½çƒ­çº¿**: 400-821-1215

å¦‚æžœä½ æœ‰ç«‹å³çš„å±é™©ï¼Œè¯·æ‹¨æ‰“ **120** æˆ–å‰å¾€æœ€è¿‘çš„åŒ»é™¢æ€¥è¯Šã€‚

åœ¨ä½ èŽ·å¾—å¸®åŠ©ä¹‹å‰ï¼Œè¯·å°½é‡ï¼š
- å¾…åœ¨å®‰å…¨çš„åœ°æ–¹
- è”ç³»ä½ ä¿¡ä»»çš„äººé™ªä¼´ä½ 
- è¿œç¦»å¯èƒ½ä¼¤å®³è‡ªå·±çš„ç‰©å“

ä½ çš„ç”Ÿå‘½å¾ˆçè´µï¼Œä¸“ä¸šçš„å¸®åŠ©å¯ä»¥è®©äº‹æƒ…å˜å¾—ä¸ä¸€æ ·ã€‚â¤ï¸`;

export interface ModerationResult {
  isCrisis: boolean;
  crisisKeywordsFound: string[];
}

/**
 * æ£€æŸ¥ç”¨æˆ·æ¶ˆæ¯æ˜¯å¦åŒ…å«å±æœºå†…å®¹
 */
export function checkModeration(text: string): ModerationResult {
  const lowerText = text.toLowerCase();

  // å…ˆæ£€æŸ¥æ˜¯å¦å‘½ä¸­è¯¯è§¦å‘è±å…è¯â€”â€”å¦‚æžœæ˜¯æ—¥å¸¸å£è¯­å°±è·³è¿‡
  const isFalsePositive = FALSE_POSITIVE_PATTERNS.some(fp => lowerText.includes(fp));

  // å¦‚æžœæ•´æ¡æ¶ˆæ¯åªæ˜¯æ—¥å¸¸å£è¯­ï¼ˆå¦‚"çƒ­æ­»äº†"ï¼‰ï¼Œä¸”ä¸åŒ…å«çœŸæ­£çš„å±æœºè¯ï¼Œç›´æŽ¥æ”¾è¡Œ
  const crisisKeywordsFound = CRISIS_KEYWORDS_ZH.filter(keyword =>
    lowerText.includes(keyword)
  );

  // å¦‚æžœå‘½ä¸­äº†è¯¯è§¦å‘è¯ï¼Œéœ€è¦æ›´ä¸¥æ ¼çš„åˆ¤æ–­ï¼š
  // åªæœ‰å½“åŒæ—¶å­˜åœ¨æ— æ³•è¢«è±å…è¯è§£é‡Šçš„å±æœºå…³é”®è¯æ—¶æ‰è§¦å‘
  if (isFalsePositive && crisisKeywordsFound.length > 0) {
    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å±æœºå…³é”®è¯éƒ½å¯ä»¥è¢«è¯¯è§¦å‘è§£é‡Š
    const realCrisisKeywords = crisisKeywordsFound.filter(keyword => {
      // "åŽ»æ­»"å¯ä»¥è¢«"çƒ­æ­»""ç´¯æ­»"ç­‰è§£é‡ŠæŽ‰
      if (keyword === 'åŽ»æ­»') {
        return !FALSE_POSITIVE_PATTERNS.some(fp => lowerText.includes(fp));
      }
      // å…¶ä»–çœŸæ­£çš„å±æœºè¯ï¼ˆå¦‚"è‡ªæ€""å‰²è…•"ï¼‰ä¸å—è±å…
      return true;
    });

    return {
      isCrisis: realCrisisKeywords.length > 0,
      crisisKeywordsFound: realCrisisKeywords,
    };
  }

  return {
    isCrisis: crisisKeywordsFound.length > 0,
    crisisKeywordsFound,
  };
}
