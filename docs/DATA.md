# Cyber Guide - 数据策略文档

## 1. 数据收集原则

### 1.1 最小化原则
我们只收集为产品运作所必需的最少数据。

### 1.2 用户知情同意
- 所有数据记录功能**默认关闭**
- 用户必须主动开启"允许匿名记录用于改进"选项
- 任何时候用户都可以关闭此选项

### 1.3 数据类型

| 数据类型 | 收集条件 | 用途 |
|---------|---------|------|
| 对话内容 | 仅当 optIn=true | 改进 AI 回应质量 |
| 案例摘要 | 仅当 optIn=true | 识别常见问题模式 |
| 错误日志 | 始终 | 系统维护和排障 |

## 2. 数据脱敏策略

### 2.1 自动脱敏规则

所有存储的对话内容必须经过以下脱敏处理：

```typescript
// 脱敏规则
const REDACTION_RULES = {
  // 手机号码：13x-xxxx-xxxx 格式
  phone: /1[3-9]\d{9}/g -> '[PHONE]',
  
  // 电子邮箱
  email: /[\w.-]+@[\w.-]+\.\w+/g -> '[EMAIL]',
  
  // 身份证号
  idCard: /\d{17}[\dXx]/g -> '[ID_CARD]',
  
  // 中文姓名（启发式）
  chineseName: /[张王李赵刘陈杨黄周吴][\u4e00-\u9fa5]{1,3}/g -> '[NAME]',
  
  // 银行卡号
  bankCard: /\d{16,19}/g -> '[BANK_CARD]',
  
  // IP 地址
  ip: /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/g -> '[IP]',
};
```

### 2.2 脱敏示例

**原始对话**:
> 我叫张小明，我的手机号是13812345678，邮箱是zhangxm@example.com

**脱敏后**:
> 我叫[NAME]，我的手机号是[PHONE]，邮箱是[EMAIL]

## 3. 案例卡片格式

当 optIn=true 时，系统会生成脱敏后的案例摘要卡片：

```json
{
  "id": "uuid-v4",
  "timestamp": "2024-01-15T10:30:00Z",
  "session_hash": "sha256-hash-of-session-id",
  "summary": {
    "primary_concern": "工作压力导致的睡眠问题",
    "emotions_detected": ["焦虑", "疲惫"],
    "techniques_suggested": ["4-7-8呼吸法", "渐进式肌肉放松"],
    "conversation_turns": 8,
    "user_feedback": null
  },
  "redacted_snippets": [
    "[USER] 最近工作压力很大...",
    "[AI] 听起来你正在经历..."
  ]
}
```

## 4. 数据存储

### 4.1 存储格式
使用 JSONL (JSON Lines) 格式存储，每行一条记录：

```
/data/case_cards.jsonl
```

### 4.2 存储位置
- 开发环境：本地文件系统
- 生产环境：需要额外配置安全存储（不在 MVP 范围内）

### 4.3 数据保留
- 案例卡片保留 90 天后自动清理（待实现）
- 用户有权随时请求删除其数据

## 5. 数据访问控制

### 5.1 访问权限

| 角色 | 权限 |
|-----|------|
| 系统 | 写入脱敏后的案例卡片 |
| 开发者 | 读取案例卡片用于改进 |
| 用户 | 无法直接访问存储数据 |

### 5.2 安全措施
- 所有 API 调用使用 HTTPS
- 敏感配置使用环境变量
- 不在日志中输出原始对话内容

## 6. 合规考虑

### 6.1 GDPR 兼容性
- 数据最小化 ✅
- 用户同意机制 ✅
- 数据可删除 ✅ (需手动)

### 6.2 中国个人信息保护法
- 明确告知收集目的 ✅
- 单独同意机制 ✅
- 敏感信息脱敏 ✅

## 7. 未来改进

- [ ] 实现自动数据过期清理
- [ ] 添加用户数据导出功能
- [ ] 实现更精确的命名实体识别脱敏
- [ ] 加密静态存储数据

